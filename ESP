-- Ensure Rexy is initialized properly
local Rexy = _G.Rexy or {}  -- Use _G to safely access or create Rexy if it doesn't exist
Rexy.ESP = Rexy.ESP or {}   -- Ensure Rexy.ESP table exists

-- Table to hold the ESP objects
Rexy.ESP.Objects = Rexy.ESP.Objects or {}

-- Default settings for ESP
Rexy.ESP.Box = true
Rexy.ESP.Name = true
Rexy.ESP.Distance = true

-- Function to create an ESP box
local function createBox(player)
    local box = {}
    box.Box = Drawing.new("Square")
    box.Box.Visible = false
    box.Box.Color = Color3.fromRGB(255, 0, 0)
    box.Box.Thickness = 2
    box.Box.Filled = false

    box.NameText = Drawing.new("Text")
    box.NameText.Visible = false
    box.NameText.Color = Color3.fromRGB(255, 255, 255)
    box.NameText.Size = 14
    box.NameText.Center = true
    box.NameText.Outline = true

    box.DistanceText = Drawing.new("Text")
    box.DistanceText.Visible = false
    box.DistanceText.Color = Color3.fromRGB(255, 255, 255)
    box.DistanceText.Size = 14
    box.DistanceText.Center = true
    box.DistanceText.Outline = true

    -- Store the created ESP object
    Rexy.ESP.Objects[player] = box
end

-- Function to update ESP box
local function updateBox(player, box, position, size, distance)
    if Rexy.ESP.Box then
        box.Box.Position = position
        box.Box.Size = size
        box.Box.Visible = true
    else
        box.Box.Visible = false
    end
    
    if Rexy.ESP.Name then
        box.NameText.Position = position + Vector2.new(0, -size.Y / 2 - 15)
        box.NameText.Text = player.Name
        box.NameText.Visible = true
    else
        box.NameText.Visible = false
    end
    
    if Rexy.ESP.Distance then
        box.DistanceText.Position = position + Vector2.new(0, size.Y / 2 + 5)
        box.DistanceText.Text = string.format("%.1f studs", distance)
        box.DistanceText.Visible = true
    else
        box.DistanceText.Visible = false
    end
end

-- Function to render ESP for all players
local function renderESP()
    for _, player in pairs(game.Players:GetPlayers()) do
        -- If the player is not in the ESP objects, create their ESP
        if not Rexy.ESP.Objects[player] then
            createBox(player)
        end

        local box = Rexy.ESP.Objects[player]
        local character = player.Character
        if character and character:FindFirstChild("Head") then
            -- Get screen position of the player's head
            local screenPosition, onScreen = workspace.CurrentCamera:WorldToScreenPoint(character.Head.Position)
            local distance = (workspace.CurrentCamera.CFrame.Position - character.Head.Position).Magnitude

            if onScreen then
                -- Adjust size based on distance
                local size = Vector2.new(1000 / distance, 1500 / distance)
                updateBox(player, box, Vector2.new(screenPosition.X - size.X / 2, screenPosition.Y - size.Y / 2), size, distance)
            else
                -- Hide if not on screen
                box.Box.Visible = false
                box.NameText.Visible = false
                box.DistanceText.Visible = false
            end
        else
            -- Hide ESP if player doesn't have a character or head
            box.Box.Visible = false
            box.NameText.Visible = false
            box.DistanceText.Visible = false
        end
    end
end

-- Connect to RenderStepped to update ESP every frame
game:GetService("RunService").RenderStepped:Connect(renderESP)

-- Finally, ensure the Rexy global variable is set so that other scripts can access it later
_G.Rexy = Rexy
